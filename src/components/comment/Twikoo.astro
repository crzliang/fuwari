---
import { commentConfig } from "@/config";
import "@/styles/twikoo.css";

interface Props {
	path: string;
}

const { path } = Astro.props;

const twikooConfig = {
	envId: commentConfig.twikoo?.envId || "",
	el: "#tcomment",
	path: path,
	lang: commentConfig.twikoo?.lang || "zh-CN",
	region: commentConfig.twikoo?.region,
};
---

<div class="twikoo-container">
  <h3 class="text-xl font-bold mb-4 text-black/90 dark:text-white/90">评论</h3>
  <div id="tcomment" class="mt-4"></div>
</div>

<script is:inline define:vars={{ twikooConfig }}>
  const initTwikoo = () => {
    const twikooVersion = '1.6.44'; // 使用一个固定的版本，避免网络请求
    const script = document.createElement('script');
    script.src = `https://cdnjs.crzliang.cn/ajax/libs/twikoo/${twikooVersion}/twikoo.all.min.js`;
    script.async = true;

    script.onload = () => {
      if (typeof twikoo !== 'undefined') {
        try {
          twikoo.init(twikooConfig);
        } catch (error) {
          console.error('Twikoo initialization failed:', error);
        }
      }
    };

    script.onerror = () => {
      console.error('Failed to load Twikoo script');
    };

    document.head.appendChild(script);
  };

  const tcomment = document.getElementById('tcomment');
  const observer = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        initTwikoo();
        observer.unobserve(entry.target);
      }
    });
  }, {
    rootMargin: '0px 0px 200px 0px' // 在视口下方200px时开始加载
  });

  observer.observe(tcomment);
</script>
